     1                                      BOOT_LOAD     equ     0x7C00 ;boot program adress
     2                                  
     3                                      ORG  BOOT_LOAD               ;load adress
     4                                  
     5                                  ;**********************************************
     6                                  ; Macro
     7                                  ;**********************************************
     8                                  %include "../include/macro.s"
     1                              <1> %macro  cdecl 1-*.nolist
     2                              <1> 
     3                              <1> 	%rep  %0 - 1
     4                              <1> 		push	%{-1:-1}
     5                              <1> 		%rotate -1
     6                              <1> 	%endrep 
     7                              <1> 	%rotate -1
     8                              <1> 
     9                              <1> 		call	%1
    10                              <1> 
    11                              <1> 	%if 1 < %0
    12                              <1> 		add		sp, (__BITS__ >> 3) * (%0 - 1)
    13                              <1> 	%endif
    14                              <1> 
    15                              <1> %endmacro
    16                              <1> 
     9                                  
    10                                  ;**********************************************
    11                                  ; Entry Point
    12                                  ;**********************************************
    13                                  
    14                                  entry:
    15                                  
    16                                    ;--------------------------------------------------
    17                                    ; BPB (BIOS Parameter Block)
    18                                    ;--------------------------------------------------
    19                                  
    20 00000000 EB58                      jmp ipl               ; jump to ipl
    21 00000002 90<rept>                  times 90 - ($ - $$) db 0x90
    22                                  
    23                                    ;--------------------------------------------------
    24                                    ; IPL(Initial Program Loader)
    25                                    ;--------------------------------------------------
    26                                  
    27                                  ipl:
    28 0000005A FA                          cli
    29                                  
    30 0000005B B80000                      mov ax, 0x0000       ; AX = 0x0000
    31 0000005E 8ED8                        mov ds, ax           ; DS = 0x0000
    32 00000060 8EC0                        mov es, ax           ; ES = 0x0000
    33 00000062 8ED0                        mov ss, ax           ; SS = 0x0000
    34 00000064 BC007C                      mov sp, BOOT_LOAD    ; SP = 0x7C00
    35                                  
    36 00000067 FB                          sti                  ; alow 
    37                                  
    38 00000068 8816[FC00]                  mov [BOOT.DRIVE], dl ; save bootdrive
    39                                  
    40                                    ;--------------------------------------------------
    41                                    ; output chars
    42                                    ;--------------------------------------------------
    43 0000006C 68[E200]E88C0083C4-         cdecl puts, .s0 
    43 00000074 02                 
    44                                  
    45                                    ;--------------------------------------------------
    46                                    ; output value
    47                                    ;--------------------------------------------------
    48 00000075 6A016A0A6A0868-             cdecl itoa, 8086, .s1, 8, 10, 0b0001  ; "     8086"
    48 0000007C [EF00]68961FE89900-
    48 00000084 83C40A             
    49 00000087 68[EF00]E8710083C4-         cdecl puts, .s1 
    49 0000008F 02                 
    50                                  
    51 00000090 6A036A0A6A0868-             cdecl itoa, 8086, .s1, 8, 10, 0b0011  ; "+    8086"
    51 00000097 [EF00]68961FE87E00-
    51 0000009F 83C40A             
    52 000000A2 68[EF00]E8560083C4-         cdecl puts, .s1
    52 000000AA 02                 
    53                                  
    54 000000AB 6A016A0A6A0868-             cdecl itoa, -8086, .s1, 8, 10, 0b0001 ; "-    8086"
    54 000000B2 [EF00]686AE0E86300-
    54 000000BA 83C40A             
    55 000000BD 68[EF00]E83B0083C4-         cdecl puts, .s1
    55 000000C5 02                 
    56                                  
    57 000000C6 6A016A0A6A0868-             cdecl itoa, -1,    .s1, 8, 10, 0b0001 ; "-       1"
    57 000000CD [EF00]6AFFE8490083-
    57 000000D5 C40A               
    58 000000D7 68[EF00]E8210083C4-         cdecl puts, .s1
    58 000000DF 02                 
    59                                    ;--------------------------------------------------
    60                                    ; End of process
    61                                    ;--------------------------------------------------
    62                                  
    63 000000E0 EBFE                      jmp $                 ;while(true)
    64                                  
    65                                    ;--------------------------------------------------
    66                                    ; Data
    67                                    ;--------------------------------------------------
    68 000000E2 426F6F74696E672E2E-     .s0 db "Booting...", 0x0A, 0x0D, 0
    68 000000EB 2E0A0D00           
    69 000000EF 202020202020202020-     .s1 db "         ", 0x0A, 0x0D, 0
    69 000000F8 0A0D00             
    70                                  
    71 000000FB 00                      ALIGN 2, db 0
    72                                  BOOT:                   ; infomation about boot drive
    73 000000FC 0000                    .DRIVE: dw 0            ; number of drive
    74                                  
    75                                  
    76                                  ;**********************************************
    77                                  ; modules
    78                                  ;**********************************************
    79                                  %include "../modules/real/puts.s"
     1                              <1> puts:
     2                              <1>   ;------------------------------------------------------------
     3                              <1>   ; construct stackframe
     4                              <1>   ;------------------------------------------------------------
     5                              <1> 
     6 000000FE 55                  <1>   push bp
     7 000000FF 89E5                <1>   mov bp, sp
     8                              <1> 
     9                              <1>   ;-----------------------------------------------------------
    10                              <1>   ; save register 
    11                              <1>   ;-----------------------------------------------------------
    12 00000101 50                  <1>   push ax
    13 00000102 53                  <1>   push bx
    14 00000103 56                  <1>   push si
    15                              <1> 
    16                              <1>   ;-----------------------------------------------------------
    17                              <1>   ; get args
    18                              <1>   ;-----------------------------------------------------------
    19 00000104 8B7604              <1>   mov si, [bp + 4]
    20                              <1> 
    21                              <1>   ;-----------------------------------------------------------
    22                              <1>   ; begining of process
    23                              <1>   ;-----------------------------------------------------------
    24 00000107 B40E                <1>   mov ah, 0x0E              ; teltype char 
    25 00000109 BB0000              <1>   mov bx, 0x0000            ; set o page number char color
    26 0000010C FC                  <1>   cld                       ; DF = 0 add address
    27                              <1>                             ; do
    28                              <1> .10L:                       ; {
    29 0000010D AC                  <1>   lodsb                     ; AL = *AL++;
    30                              <1>                             ;
    31 0000010E 3C00                <1>   cmp al, 0                 ; if (0 == AL)
    32 00000110 7404                <1>   je   .10E                 ;   break;
    33                              <1>                             ; 
    34 00000112 CD10                <1>   int 0x10                  ; Int10(0x0E, AL); 
    35 00000114 EBF7                <1>   jmp .10L                  ; while(1);
    36                              <1> .10E:
    37                              <1> 
    38                              <1> 
    39                              <1>   ;-----------------------------------------------------------
    40                              <1>   ; return of register
    41                              <1>   ;-----------------------------------------------------------
    42 00000116 5E                  <1>   pop si
    43 00000117 5B                  <1>   pop bx
    44 00000118 58                  <1>   pop ax
    45                              <1> 
    46                              <1>   ;-----------------------------------------------------------
    47                              <1>   ; deconstruct stackframe
    48                              <1>   ;-----------------------------------------------------------
    49 00000119 89EC                <1>   mov sp, bp
    50 0000011B 5D                  <1>   pop bp
    51                              <1> 
    52 0000011C C3                  <1>   ret
    80                                  %include "../modules/real/itoa.s"
     1                              <1> ;**************************************************************
     2                              <1> ; void itoa(num, buff, size, radix, flag)
     3                              <1> ;   return void
     4                              <1> ;   num    original
     5                              <1> ;   buff   disnation buffer
     6                              <1> ;   size   buff size
     7                              <1> ;   radix  2, 8, 10, 16
     8                              <1> ;   flags  def bit flag 
     9                              <1> ;          -------------------------
    10                              <1> ;          B2: filling space 0
    11                              <1> ;          B1: set sign
    12                              <1> ;          B0: vaule hadle signed
    13                              <1> ;**************************************************************
    14                              <1> itoa:
    15                              <1> 
    16                              <1>   ;-----------------------------------------------------------
    17                              <1>   ; construct stackframe
    18                              <1>   ;-----------------------------------------------------------
    19                              <1>                                 ; BP+ 12| flag
    20                              <1>                                 ; BP+ 10| radix
    21                              <1>                                 ; BP+  8| buffer size
    22                              <1>                                 ; BP+  6| buffer address
    23                              <1>                                 ; BP+  4| value
    24                              <1>                                 ; BP+  2| IP(address of return value)
    25                              <1>                                 ; BP+  0| BP(original value)
    26 0000011D 55                  <1>       push bp
    27 0000011E 89E5                <1>       mov  bp, sp
    28                              <1>   ;-----------------------------------------------------------
    29                              <1>   ; save register
    30                              <1>   ;-----------------------------------------------------------
    31 00000120 50                  <1>       push ax                   
    32 00000121 53                  <1>       push bx                   
    33 00000122 51                  <1>       push cx                   
    34 00000123 52                  <1>       push dx                   ;
    35 00000124 56                  <1>       push si
    36 00000125 57                  <1>       push di
    37                              <1> 
    38                              <1>   ;-----------------------------------------------------------
    39                              <1>   ; get arg
    40                              <1>   ;-----------------------------------------------------------
    41 00000126 8B4604              <1>       mov ax, [bp + 4]          ; val = value; 
    42 00000129 8B7606              <1>       mov si, [bp + 6]          ; dst = buffer address
    43 0000012C 8B4E08              <1>       mov cx, [bp + 8]          ; size = remaining buffe size
    44                              <1>       
    45 0000012F 89F7                <1>       mov di, si                ; end of buffer
    46 00000131 01CF                <1>       add di, cx                ; dst = &dst[size - 1];
    47 00000133 4F                  <1>       dec di                    ; 
    48                              <1> 
    49 00000134 8B5E0C              <1>       mov bx, word [bp + 12]    ; flags = option;
    50                              <1> 
    51                              <1>   ;-----------------------------------------------------------
    52                              <1>   ; check signed or not
    53                              <1>   ;-----------------------------------------------------------
    54 00000137 F7C30100            <1>       test bx, 0b0001           ; if (flags & 0x01)
    55 0000013B 7408                <1> .10Q: je .10E                   ; {
    56 0000013D 83F800              <1>       cmp ax, 0                 ;   if (val < 0)
    57 00000140 7D03                <1> .12Q: jge .12E                  ;   {
    58 00000142 83CB02              <1>       or bx, 0b0010             ;    flags |= 2;
    59                              <1> .12E:                           ;   }
    60                              <1> .10E:                           ; }
    61                              <1> 
    62                              <1>   ;-----------------------------------------------------------
    63                              <1>   ; check sign
    64                              <1>   ;-----------------------------------------------------------
    65 00000145 F7C30200            <1>       test bx, 0b0010           ; if (flags & 0x02)// check sign
    66 00000149 7410                <1> .20Q: je .20E                   ; {
    67 0000014B 83F800              <1>       cmp ax, 0                 ;   if (val < 0)
    68 0000014E 7D07                <1> .22Q: jge .22F                  ;   {
    69 00000150 F7D8                <1>       neg ax                    ;     val *= -1; //reverse sign
    70 00000152 C6042D              <1>       mov [si], byte '-'        ;     *dst = '-';// ouput sign
    71 00000155 EB03                <1>       jmp .22E                  ;   }
    72                              <1> .22F:                           ;   else
    73                              <1>                                 ;   {
    74 00000157 C6042B              <1>       mov [si], byte '+'        ;     *dst = '+';//output sign
    75                              <1> .22E:                           ;   }
    76 0000015A 49                  <1>       dec cx                    ;   size--;      //decriment buff size
    77                              <1> .20E:                           ; }
    78                              <1> 
    79                              <1>   ;-----------------------------------------------------------
    80                              <1>   ; convert to ascii
    81                              <1>   ;-----------------------------------------------------------
    82 0000015B 8B5E0A              <1>       mov bx, [bp + 10]             ; BX = radix;
    83                              <1> .30L:                               ; do
    84                              <1>                                     ; {
    85 0000015E BA0000              <1>       mov dx, 0                     ; 
    86 00000161 F7F3                <1>       div bx                        ; DX = DX:AX % radix;
    87                              <1>                                     ; AX = DX:AX / radix;
    88 00000163 89D6                <1>       mov si, dx                    ; // refer ascii table
    89 00000165 8A94[8D01]          <1>       mov dl, byte [.ascii + si]    ; DL = ASCII[DX];
    90                              <1>                                     ;
    91 00000169 8815                <1>       mov [di], dl                  ; *dst = DL;
    92 0000016B 4F                  <1>       dec di                        ; dst--;
    93                              <1>                                     ;
    94 0000016C 83F800              <1>       cmp ax, 0                     ;
    95 0000016F E0ED                <1>       loopnz .30L                   ; } while (AX);
    96                              <1> .30E:
    97                              <1> 
    98                              <1>   ;-----------------------------------------------------------
    99                              <1>   ; filing space
   100                              <1>   ;-----------------------------------------------------------
   101 00000171 83F900              <1>       cmp cx, 0                     ; if (size)
   102 00000174 740D                <1> .40Q: je .40E                       ; {
   103 00000176 B020                <1>       mov al, ' '                   ;   AL = ' '; // filing plank by ' '
   104 00000178 837E0C04            <1>       cmp [bp + 12], word 0b0100    ;   if (flags & 0x04)
   105 0000017C 7502                <1> .42Q  jne .42E                      ;   {
   106 0000017E B030                <1>       mov al, '0'                   ;     AL = '0'; // '0'
   107                              <1> .42E:                               ;   }
   108 00000180 FD                  <1>       std                           ;   // DF = 1(negative direction)
   109 00000181 F3AA                <1>       rep stosb                     ;   while (--CX) *DI-- = ' ';
   110                              <1> .40E:                               ; ]
   111                              <1> 
   112                              <1>   ;-----------------------------------------------------------
   113                              <1>   ; return of register
   114                              <1>   ;-----------------------------------------------------------
   115 00000183 58                  <1>       pop ax
   116 00000184 5B                  <1>       pop bx
   117 00000185 59                  <1>       pop cx
   118 00000186 5A                  <1>       pop dx
   119 00000187 5E                  <1>       pop si
   120 00000188 5F                  <1>       pop di
   121                              <1> 
   122                              <1>   ;-----------------------------------------------------------
   123                              <1>   ; deconstruct stackframe
   124                              <1>   ;-----------------------------------------------------------
   125 00000189 89EC                <1>       mov sp, bp
   126 0000018B 5D                  <1>       pop bp
   127                              <1> 
   128 0000018C C3                  <1>       ret
   129                              <1> 
   130                              <1>   ;-----------------------------------------------------------
   131                              <1>   ; ASCII TABLE
   132                              <1>   ;-----------------------------------------------------------
   133 0000018D 303132333435363738- <1> .ascii db "0123456789ABCDEF"        ; ascii table
   133 00000196 39414243444546      <1>
    81                                    
    82                                  ;**********************************************
    83                                  ; Boot Flag(End of Head 512 bytes)
    84                                  ;**********************************************
    85 0000019D 00<rept>                  times 510 - ($ - $$) db 0x00
    86 000001FE 55AA                      db 0x55, 0xAA
    87                                  
    88                                  
    89                                  
